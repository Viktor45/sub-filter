[EN](FILTER_RULES_en.md) / [RU](FILTER_RULES_ru.md)  / [ZH](FILTER_RULES_zh.md) 

- [Документация для `rules.yaml`](#документация-для-rulesyaml)
    - [Структура файла](#структура-файла)
    - [1. `required_params` — Обязательные параметры](#1-required_params--обязательные-параметры)
    - [2. `allowed_values` — Разрешённые значения](#2-allowed_values--разрешённые-значения)
    - [3. `forbidden_values` — Запрещённые значения](#3-forbidden_values--запрещённые-значения)
    - [4. `conditional` — Условные правила](#4-conditional--условные-правила)
    - [Актуальный пример для VLESS](#актуальный-пример-для-vless)
    - [Особенности валидации](#особенности-валидации)

# Документация для `rules.yaml`

Файл `rules.yaml` — это **набор правил** для программы `sub-filter`. Эти правила определяют, какие прокси-ссылки считаются **корректными и безопасными**, а какие — **недопустимыми** и подлежат удалению.

Представьте, что `sub-filter` — это **умный фильтр для воды**, а `rules.yaml` — его **инструкция**: какие примеси удалять, а какую чистую воду пропускать.

---

### Структура файла

Файл разделён на **секции по протоколам**. Поддерживаемые протоколы:

- `vless`
- `vmess`
- `trojan`
- `hysteria2`
- `ss`

В каждой секции могут присутствовать **четыре типа правил**:

---

### 1. `required_params` — Обязательные параметры

Список параметров, которые **обязательно должны присутствовать** в ссылке.

- Если хотя бы одного параметра **нет** — ссылка отклоняется.
- **Пример для VLESS:**
  ```yaml
  required_params: [encryption, sni]
  ```

---

### 2. `allowed_values` — Разрешённые значения

Список **допустимых значений** для конкретного параметра.

- Если значение параметра **не входит** в список — ссылка отклоняется.
- **Пример:**
  ```yaml
  allowed_values:
    security: [tls, reality]
    flow:
      - "xtls-rprx-vision"
      - "xtls-rprx-vision-udp443"
  ```

> ⚠️ Правило применяется **только если параметр присутствует**. Отсутствующие параметры проверяются через `required_params`.

---

### 3. `forbidden_values` — Запрещённые значения

Список **запрещённых значений** для конкретного параметра.

- Если значение **входит** в список — ссылка отклоняется.
- **Имеет приоритет над `allowed_values`**.
- **Пример:**
  ```yaml
  forbidden_values:
    security: [none]
  ```

> ⚠️ Это правило **глобально запрещает** `security=none` во всех случаях.  
> Чтобы разрешить `security=none` только для `type=ws`, используйте **условные правила**.

---

### 4. `conditional` — Условные правила

Правила, которые применяются **только при выполнении определённых условий**.

Структура:
- `when` — условия активации (все должны быть истинны)
- `require` — обязательные параметры (если условие выполнено)
- `forbidden_values` — запрещённые значения (если условие выполнено)

**Примеры:**
```yaml
conditional:
  # Если security=reality, обязательно должен быть pbk
  - when: { security: "reality" }
    require: [pbk]

  # Если type=grpc, обязательно должен быть serviceName
  - when: { type: "grpc" }
    require: [serviceName]

  # Если type НЕ ws, запрещать security=none
  - when: { type: { not: "ws" } }
    forbidden_values: { security: ["none"] }
```

---

### Актуальный пример для VLESS

```yaml
vless:
  required_params:
    - encryption
    - sni
  allowed_values:
    security: ["tls", "reality"]
    flow:
      - "xtls-rprx-vision"
      - "xtls-rprx-vision-udp443"
  conditional:
    - when: { security: "reality" }
      require: ["pbk"]
    - when: { type: "grpc" }
      require: ["serviceName"]
    - when: { type: { not: "ws" } }
      forbidden_values: { security: ["none"] }
```

**Объяснение:**
1. **Во всех VLESS-ссылках** обязательно должны быть `encryption` и `sni`.
2. Параметр `security` может быть только `tls` или `reality`.
3. Если `security=reality`, **обязательно** должен быть `pbk`.
4. Если `type=grpc`, **обязательно** должен быть `serviceName`.
5. **Только для `type=ws`** разрешено отсутствие `security` (интерпретируется как `security=none`).  
   Для всех остальных типов подключений `security=none` **запрещено**.

---

### Особенности валидации

- Для VLESS, если параметр `security` **отсутствует**, он **автоматически считается равным `none`**.
- Правила применяются **только к присутствующим параметрам**.
- Порядок проверки:  
  `forbidden_values` → `allowed_values` → `conditional`
- Все сравнения значений — **регистрозависимые** (используйте точные значения из спецификаций).

---